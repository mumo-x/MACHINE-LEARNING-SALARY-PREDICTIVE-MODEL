<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="static/styles.css">
    <title>Salary Predictor</title>
</head>
<body>
    <div class="main-container">
        <header>
            <h1><i class="fas fa-chart-line"></i> Machine Learning Salary Predictor</h1>
            <p><i class="fas fa-upload"></i> Upload your CSV file to predict salaries</p>
        </header>
        <div class="card">
            <form id="upload-form" method="POST" action="/upload_csv" enctype="multipart/form-data" style="display: inline-block;">
                <input type="file" id="file-input" name="file" accept=".csv" required>
                <button type="submit" class="btn-cta upload-btn-white"><i class="fas fa-cloud-upload-alt"></i> Upload</button>
                <button type="button" id="reset-btn" class="btn-cta" style="background: #ff5e62; margin-left: 10px;"><i class="fas fa-refresh"></i> Reset</button>
                <div style="margin-top: 10px; font-size: 0.9em;">
                    <a href="/static/sample_data.csv" download class="sample-link"><i class="fas fa-download"></i> Download Sample CSV</a>
                </div>
            </form>
            <div style="display: inline-block; vertical-align: top; margin-left: 20px;">
                <button id="predict-new-salary-btn" class="btn-cta predict-btn-white" onclick="window.location.href='/predict'"><i class="fas fa-calculator"></i> Predict New Salary</button>
            </div>
            <div id="upload-message"></div>
            <div id="performance-table-container" style="margin-top: 20px;"></div>
            <div id="best-model" style="margin-top: 10px; font-weight: bold;"></div>
        </div>
    </div>
    <script>
        document.getElementById('upload-form').addEventListener('submit', async function(event) {
            // Prevent browser extension interference
            event.stopImmediatePropagation();
            event.preventDefault();
            const uploadMessage = document.getElementById('upload-message');
            const performanceTableContainer = document.getElementById('performance-table-container');
            const bestModelDiv = document.getElementById('best-model');
            
            // Clear previous results
            uploadMessage.textContent = 'Uploading and processing data...';
            uploadMessage.style.color = '#fff';
            performanceTableContainer.innerHTML = '';
            bestModelDiv.textContent = '';

            const fileInput = document.getElementById('file-input');
            if (fileInput.files.length === 0) {
                uploadMessage.textContent = 'Please select a CSV file.';
                uploadMessage.style.color = '#ff5e62';
                return;
            }

            // Check file extension
            const fileName = fileInput.files[0].name;
            if (!fileName.toLowerCase().endsWith('.csv')) {
                uploadMessage.textContent = 'Error: Please upload a CSV file.';
                uploadMessage.style.color = '#ff5e62';
                return;
            }

            // Check file size (limit to 10MB)
            if (fileInput.files[0].size > 10 * 1024 * 1024) {
                uploadMessage.textContent = 'Error: File size exceeds 10MB limit.';
                uploadMessage.style.color = '#ff5e62';
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            // Add a timeout to abort the request if it takes too long
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout

            try {
                const response = await fetch('/upload_csv', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                }).catch(error => {
                    if (error.name === 'AbortError') {
                        throw new Error('Request timed out. The server took too long to respond.');
                    }
                    throw error;
                });

                // Clear the timeout
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error (${response.status}): ${errorText}`);
                }

                const data = await response.json();
                if (data.error) {
                    uploadMessage.textContent = 'Error: ' + data.error;
                    uploadMessage.style.color = '#ff5e62';
                } else if (data.performance) {
                            uploadMessage.textContent = 'Model trained successfully.';
                            uploadMessage.style.color = '#fff';
                            const performance = data.performance;
                            
                            // Store results in sessionStorage for back button functionality
                            sessionStorage.setItem('modelResults', JSON.stringify(data));

                            // Create results page layout
                            const resultsContainer = document.createElement('div');
                            resultsContainer.innerHTML = `
                                <style>
                                    .results-container { margin-top: 20px; }
                                    .section-title { font-size: 24px; font-weight: bold; margin: 30px 0 15px 0; color: #fff; }
                                    .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
                                    .data-preview-card, .model-performance-card, .boxplots-card { background: #2c3e50; padding: 20px; border-radius: 10px; color: #fff; margin-bottom: 20px; }
                                    .data-preview-card h3, .model-performance-card h3, .boxplots-card h3 { margin-top: 0; color: #fff; }
                                    .table-container table { width: 100%; border-collapse: collapse; }
                                    .table-container th, .table-container td { border: 1px solid #34495e; padding: 8px; text-align: left; color: #fff; }
                                    .table-container th { background-color: #34495e; font-weight: bold; }
                                    .best-model { background-color: #27ae60; }
                                    .boxplots-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
                                    .boxplot-item h4 { margin: 0 0 10px 0; font-size: 14px; color: #fff; }
                                    .img-container { text-align: center; }
                                    .img-container img { max-width: 100%; height: auto; border-radius: 5px; }
                                    .model-note { margin-top: 10px; font-size: 12px; color: #bdc3c7; }
                                    .sample-link { color: #fff; text-decoration: none; font-weight: 500; }
                                    .sample-link:hover { color: #00e5ff; text-decoration: underline; }
                                    @media (max-width: 768px) {
                                        .analysis-grid, .boxplots-grid { grid-template-columns: 1fr; }
                                    }
                                </style>
                                <div class="results-container">
                                    <h2 class="section-title">Data</h2>
                                    <div class="data-preview-card">
                                        <h3>First 5 Rows of Uploaded Data</h3>
                                        <div class="table-container">
                                            <table id="data-preview-table">
                                                <thead id="data-preview-thead"></thead>
                                                <tbody id="data-preview-tbody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <h2 class="section-title">Model Performance Analysis</h2>
                                    <div class="analysis-grid">
                                        <div class="model-performance-card">
                                            <h3>Model Performance Comparison</h3>
                                            <div class="table-container">
                                                <table>
                                                    <thead>
                                                        <tr>
                                                            <th>Model</th>
                                                            <th>RMSE</th>
                                                            <th>R² Score</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="performance-tbody">
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="model-note">
                                                <p>* Models sorted by R² Score (higher is better)</p>
                                            </div>
                                        </div>
                                        
                                        <div class="boxplots-card">
                                            <h3>Outlier Analysis</h3>
                                            <div class="boxplots-grid">
                                                <div class="boxplot-item">
                                                    <h4>Before Outlier Removal</h4>
                                                    <div class="img-container">
                                                        ${data.boxplot_before ? `<img src="${data.boxplot_before}" alt="Boxplot Before" onerror="this.style.display='none'; this.parentElement.innerHTML='<p>No image available</p>';" />` : '<p>No image available</p>'}
                                                    </div>
                                                </div>
                                                <div class="boxplot-item">
                                                    <h4>After Outlier Removal</h4>
                                                    <div class="img-container">
                                                        ${data.boxplot_after ? `<img src="${data.boxplot_after}" alt="Boxplot After" onerror="this.style.display='none'; this.parentElement.innerHTML='<p>No image available</p>';" />` : '<p>No image available</p>'}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // Populate data preview table
                            if (data.data_preview && data.data_preview.length > 0) {
                                const previewThead = resultsContainer.querySelector('#data-preview-thead');
                                const previewTbody = resultsContainer.querySelector('#data-preview-tbody');
                                
                                // Create header row
                                const headerRow = document.createElement('tr');
                                Object.keys(data.data_preview[0]).forEach(column => {
                                    const th = document.createElement('th');
                                    th.textContent = column;
                                    headerRow.appendChild(th);
                                });
                                previewThead.appendChild(headerRow);
                                
                                // Create data rows
                                data.data_preview.forEach(row => {
                                    const tr = document.createElement('tr');
                                    Object.values(row).forEach(value => {
                                        const td = document.createElement('td');
                                        td.textContent = value;
                                        tr.appendChild(td);
                                    });
                                    previewTbody.appendChild(tr);
                                });
                            }
                            
                            // Populate performance table
                            const tbody = resultsContainer.querySelector('#performance-tbody');
                            const sortedEntries = Object.entries(performance).sort((a, b) => b[1]['R2 Score'] - a[1]['R2 Score']);
                            
                            let bestModel = null;
                            let bestR2 = -Infinity;
                            
                            sortedEntries.forEach(([modelName, metrics], index) => {
                                const row = document.createElement('tr');
                                if (index === 0) row.className = 'best-model';
                                
                                row.innerHTML = `
                                    <td>${modelName}</td>
                                    <td>${metrics['RMSE'].toFixed(4)}</td>
                                    <td>${metrics['R2 Score'].toFixed(4)}</td>
                                `;
                                tbody.appendChild(row);
                                
                                if (metrics['R2 Score'] > bestR2) {
                                    bestR2 = metrics['R2 Score'];
                                    bestModel = modelName;
                                }
                            });
                            
                            performanceTableContainer.appendChild(resultsContainer);
                            bestModelDiv.innerHTML = `<i class="fas fa-trophy"></i> Best Model: ${bestModel} (R² Score: ${bestR2.toFixed(4)})`;
                            bestModelDiv.style.fontSize = '18px';
                            bestModelDiv.style.color = '#00e5ff';
                            bestModelDiv.style.textAlign = 'center';
                            bestModelDiv.style.padding = '15px';
                            bestModelDiv.style.background = 'rgba(0, 229, 255, 0.1)';
                            bestModelDiv.style.borderRadius = '12px';
                            bestModelDiv.style.border = '2px solid #00e5ff';
                            bestModelDiv.style.backdropFilter = 'blur(10px)';
                        } else {
                            uploadMessage.textContent = 'Unexpected response from server.';
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        uploadMessage.textContent = 'Upload failed: ' + error.message;
                        uploadMessage.style.color = '#ff5e62';
                        
                        // Add retry button
                        const retryButton = document.createElement('button');
                        retryButton.innerHTML = '<i class="fas fa-redo"></i> Retry Upload';
                        retryButton.className = 'btn-cta';
                        retryButton.style.marginTop = '10px';
                        retryButton.style.marginLeft = '10px';
                        retryButton.onclick = function() {
                            const form = document.getElementById('upload-form');
                            const event = new Event('submit', { bubbles: true, cancelable: true });
                            form.dispatchEvent(event);
                        };
                        
                        uploadMessage.appendChild(document.createElement('br'));
                        uploadMessage.appendChild(retryButton);
                    }
        });
        
        // Function to restore results from sessionStorage
        function restoreResults() {
            const savedResults = sessionStorage.getItem('modelResults');
            if (savedResults) {
                const data = JSON.parse(savedResults);
                const uploadMessage = document.getElementById('upload-message');
                const performanceTableContainer = document.getElementById('performance-table-container');
                const bestModelDiv = document.getElementById('best-model');
                
                uploadMessage.textContent = 'Model trained successfully.';
                uploadMessage.style.color = '#fff';
                const performance = data.performance;
                
                // Recreate the results display (same code as above)
                const resultsContainer = document.createElement('div');
                resultsContainer.innerHTML = `
                    <style>
                        .results-container { margin-top: 20px; }
                        .section-title { font-size: 24px; font-weight: bold; margin: 30px 0 15px 0; color: #fff; }
                        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
                        .data-preview-card, .model-performance-card, .boxplots-card { background: #2c3e50; padding: 20px; border-radius: 10px; color: #fff; margin-bottom: 20px; }
                        .data-preview-card h3, .model-performance-card h3, .boxplots-card h3 { margin-top: 0; color: #fff; }
                        .table-container table { width: 100%; border-collapse: collapse; }
                        .table-container th, .table-container td { border: 1px solid #34495e; padding: 8px; text-align: left; color: #fff; }
                        .table-container th { background-color: #34495e; font-weight: bold; }
                        .best-model { background-color: #27ae60; }
                        .boxplots-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
                        .boxplot-item h4 { margin: 0 0 10px 0; font-size: 14px; color: #fff; }
                        .img-container { text-align: center; }
                        .img-container img { max-width: 100%; height: auto; border-radius: 5px; }
                        .model-note { margin-top: 10px; font-size: 12px; color: #bdc3c7; }
                        .sample-link { color: #fff; text-decoration: none; font-weight: 500; }
                        .sample-link:hover { color: #00e5ff; text-decoration: underline; }
                        @media (max-width: 768px) {
                            .analysis-grid, .boxplots-grid { grid-template-columns: 1fr; }
                        }
                    </style>
                    <div class="results-container">
                        <h2 class="section-title">Data</h2>
                        <div class="data-preview-card">
                            <h3>First 5 Rows of Uploaded Data</h3>
                            <div class="table-container">
                                <table id="data-preview-table">
                                    <thead id="data-preview-thead"></thead>
                                    <tbody id="data-preview-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                        <h2 class="section-title">Model Performance Analysis</h2>
                        <div class="analysis-grid">
                            <div class="model-performance-card">
                                <h3>Model Performance Comparison</h3>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Model</th>
                                                <th>RMSE</th>
                                                <th>R² Score</th>
                                            </tr>
                                        </thead>
                                        <tbody id="performance-tbody">
                                        </tbody>
                                    </table>
                                </div>
                                <div class="model-note">
                                    <p>* Models sorted by R² Score (higher is better)</p>
                                </div>
                            </div>
                            
                            <div class="boxplots-card">
                                <h3>Outlier Analysis</h3>
                                <div class="boxplots-grid">
                                    <div class="boxplot-item">
                                        <h4>Before Outlier Removal</h4>
                                        <div class="img-container">
                                            ${data.boxplot_before ? `<img src="${data.boxplot_before}" alt="Boxplot Before" onerror="this.style.display='none'; this.parentElement.innerHTML='<p>No image available</p>';" />` : '<p>No image available</p>'}
                                        </div>
                                    </div>
                                    <div class="boxplot-item">
                                        <h4>After Outlier Removal</h4>
                                        <div class="img-container">
                                            ${data.boxplot_after ? `<img src="${data.boxplot_after}" alt="Boxplot After" onerror="this.style.display='none'; this.parentElement.innerHTML='<p>No image available</p>';" />` : '<p>No image available</p>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Populate data preview table
                if (data.data_preview && data.data_preview.length > 0) {
                    const previewThead = resultsContainer.querySelector('#data-preview-thead');
                    const previewTbody = resultsContainer.querySelector('#data-preview-tbody');
                    
                    const headerRow = document.createElement('tr');
                    Object.keys(data.data_preview[0]).forEach(column => {
                        const th = document.createElement('th');
                        th.textContent = column;
                        headerRow.appendChild(th);
                    });
                    previewThead.appendChild(headerRow);
                    
                    data.data_preview.forEach(row => {
                        const tr = document.createElement('tr');
                        Object.values(row).forEach(value => {
                            const td = document.createElement('td');
                            td.textContent = value;
                            tr.appendChild(td);
                        });
                        previewTbody.appendChild(tr);
                    });
                }
                
                // Populate performance table
                const tbody = resultsContainer.querySelector('#performance-tbody');
                const sortedEntries = Object.entries(performance).sort((a, b) => b[1]['R2 Score'] - a[1]['R2 Score']);
                
                let bestModel = null;
                let bestR2 = -Infinity;
                
                sortedEntries.forEach(([modelName, metrics], index) => {
                    const row = document.createElement('tr');
                    if (index === 0) row.className = 'best-model';
                    
                    row.innerHTML = `
                        <td>${modelName}</td>
                        <td>${metrics['RMSE'].toFixed(4)}</td>
                        <td>${metrics['R2 Score'].toFixed(4)}</td>
                    `;
                    tbody.appendChild(row);
                    
                    if (metrics['R2 Score'] > bestR2) {
                        bestR2 = metrics['R2 Score'];
                        bestModel = modelName;
                    }
                });
                
                performanceTableContainer.appendChild(resultsContainer);
                bestModelDiv.innerHTML = `<i class="fas fa-trophy"></i> Best Model: ${bestModel} (R² Score: ${bestR2.toFixed(4)})`;
                bestModelDiv.style.fontSize = '18px';
                bestModelDiv.style.color = '#00e5ff';
                bestModelDiv.style.textAlign = 'center';
                bestModelDiv.style.padding = '15px';
                bestModelDiv.style.background = 'rgba(0, 229, 255, 0.1)';
                bestModelDiv.style.borderRadius = '12px';
                bestModelDiv.style.border = '2px solid #00e5ff';
                bestModelDiv.style.backdropFilter = 'blur(10px)';
            }
        }
        
        // Check if we're returning from predict page and restore results
        window.addEventListener('load', function() {
            if (sessionStorage.getItem('returnFromPredict') === 'true') {
                sessionStorage.removeItem('returnFromPredict');
                restoreResults();
            }
        });
        
        // Reset button functionality
        document.getElementById('reset-btn').addEventListener('click', function() {
            document.getElementById('file-input').value = '';
            document.getElementById('upload-message').textContent = '';
            document.getElementById('performance-table-container').innerHTML = '';
            document.getElementById('best-model').textContent = '';
            sessionStorage.removeItem('modelResults');
        });
    </script>
</body>
</html>
